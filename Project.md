これまでの議論を統合し、本プロジェクトの企画仕様書（要件定義書）の初案をまとめました。このドキュメントは、実装のガイドラインおよび、公開時のポートフォリオの解説資料としても活用できる構成にしています。

---

# 企画仕様書：TOON-Flow Visualizer (仮)

**〜AIによる対話型ロジック構造化・視覚化システム〜**

## 1. プロジェクトの背景と目的

自然言語による指示や状況説明（例：「JARVISがおかしい」）は曖昧であり、論理的な欠落や矛盾を含みやすい。本プロジェクトは、AIとの対話を通じてこれらの曖昧な情報を**TOON（Token-Oriented Object Notation）**形式で構造化し、リアルタイムでフローチャート化することで、**「思考のバグ（未実装・矛盾）」を視覚的に特定・解消する**ことを目的とする。

## 2. システムアーキテクチャ

信頼性と効率を両立させるため、以下の2段階AIプロセスを採用する。

1. **Semantic Layer (大型LLM):** ユーザーの自由入力を受け取り、文脈を理解してTOON形式（Markdownベース）のログを生成・追記する。
2. **Structural Layer (軽量LLM/Gemma等):** TOONファイルを解析し、ノードとエッジの関係を抽出してJSONデータに変換する。
3. **Visualization Layer (ルールベース):** 抽出されたJSONに基づき、定義された対応表（TOON-Mermaid対応表）に従ってMermaid.jsコードを生成し、Streamlit上に描画する。

---

## 3. 機能要件

### 3.1 対話型TOON構築機能

* ユーザーとのチャットを通じて情報を収集し、Markdownファイル（`.md`）に差分追記（Logging）する。
* セッション開始時に既存のTOONファイルを読み込み、過去の文脈を維持する。

### 3.2 視覚的拡張（図解）機能

* **Mermaid.jsによる描画:** TOONの各タイプを特定の形状にマッピングして表示する。
* **「論理の穴」の検知:** 出口のない分岐や、接続先が未定義のノードを `MISSING`（六角形・赤色）として強調表示する。
* **スタイル制御:** 現在進行中のノードや完了した工程を色分けして視覚的に強調する。

### 3.3 状態管理機能

* Streamlitの `session_state` を利用し、対話の進捗とTOONのスナップショットを同期する。

---

## 4. データ定義（TOON-Mermaid マッピング）

現場作業での「見やすさ」と「直感性」を重視した定義を採用する。

| ノードタイプ | Mermaid形状 | 記法 | 意味・役割 |
| --- | --- | --- | --- |
| **START/END** | スタジアム形 | `([ ])` | フローの起点・終着点。 |
| **PROCESS** | 長方形 | `[ ]` | 具体的な作業内容や命令。 |
| **DECISION** | 菱形 | `{ }` | 条件分岐。Yes/Noなどのルート分け。 |
| **IO_DATA** | 平行四辺形 | `[/ /]` | 画面入力や手動操作。 |
| **STORAGE** | 円筒形 | `[( )]` | データベースやログファイルへの操作。 |
| **MISSING** | 六角形（赤） | `{{ }}` | **未実装・要検討箇所。** |

---

## 5. UI/UX 設計案

現場での作業効率を最大化する「3ペイン構成」を想定する。

1. **左ペイン（Chat）:** ユーザーがAIと対話するエリア。
2. **中央ペイン（Flowchart）:** Mermaid.jsによって描画される動的なフローチャート。
3. **右ペイン（Source）:** 現在のTOONファイルの生データ表示。

---

## 6. 非機能要件

* **拡張性:** TOONファイルを共通言語とすることで、将来的にPythonコードの自動生成機能などを追加可能にする。
* **堅牢性:** 軽量LLMがパースに失敗した場合でも、ルールベースのバリデーターによって図解が崩れるのを防止する。
* **軽量化:** 2段階目の解析にGemma:4b等の小型モデルを使用することで、レスポンスの高速化を図る。

---

## 次のステップ：実装フェーズ

この仕様書に基づき、まずは**「TOON（Markdown）を読み込んでMermaid（文字列）を生成するコアロジック」**の実装から開始するのが確実です。

このロジックをPythonで記述するにあたって、**「入力となるTOONファイルのサンプル」と「それに対応するPythonの変換関数」**のドラフトを、実際のコード形式で作成してみますか？